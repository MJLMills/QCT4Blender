\documentclass{report}

\usepackage{amsmath,amsthm,amssymb}
%\usepackage[backend=biber]{biblatex}
%\addbibresource{main.bib}

\title{QCT for Blender \\
       \large ... \\ 
       A Blender Extension for Importing Quantum Chemical Topologies}

\author{Matthew J L Mills}

\begin{document}

\maketitle

\chapter{Introduction}

Blender is a free and open source 3D animation suite, supporting (amongst other things) modelling, animation and 
rendering of 3D scenes. 
Blender also provides an API for Python scripting, allowing the writing of extensions to the program's functionality.
This document describes one such extension (termed an Add-On), which allows the user to read a file containing a set 
of objects constituting the topology of a scalar function of the chemical wavefunction of a system (the electron 
density $\rho(r)$ being the canonical example) and creates corresponding 3D objects for manipulation in Blender.
This functionality allows the full power of Blender to be applied in creating images of such topologies.

Generation of pictorial representations of topologies is an important and typically overlooked problem.
Blender, representing the state of the art for 3D drawing, has the potential to put QCT imaging at the edge 
of modern graphical capabilities.
Past and current QCT drawing programs have at best provided access to the OpenGL API (www.opengl.org).
Adding access to Blender allows the full use of the Blender Render and Cycles engines, massively increasing the 
potential for creativity and professional appearance of QCT images.
Drawing on the same 3D canvas as used for the topology is also better facilitated by Blender, as this functionality
already exists and is very flexible in Blender.
Arbitrary shapes are simple to draw/place/manipulate in blender, allowing for easy 3D annotation of rendered 
topologies.

The basic goal of the described Add-On is to allow the user to read a topology into Blender with a default 
acceptable representation, and then to allow the user to apply the full set of Blender tools towards making 
rendered images specific to their goals.

\section{Things QCT for Blender Does Not Do}

QCT for Blender is not able to perform topological analysis of scalar functions and never will be.
A number of mature programs already exist, and a list is provided below.

Morphy
AIMAll

\chapter{Installation and Quick Start}

\section{Installation}

This section describes the 2 ways of installing QCT4B. The obvious prerequisite is Blender itself. 
Blender installation is covered in detail elsewhere, and here it is assumed you have a working version.
There are two options for using the script.

The more permanent solution is installation, i.e. putting the script into your Blender user preferences directory, which will cause it to appear in the Add-Ons list in the User Preferences window.
Doing this directly is OS-dependent.
This dependence can be avoided by installing from inside Blender.
Navigate to User Preferences and choose the 'Add-Ons' tab.
Click "Install Add-On" and navigate to the location of the script on your machine.
This will copy the script to you personal Add-Ons directory, and it will now appear in the list of available Add-Ons.
To activate it you must tick the checkbox for that entry. 
You can then save the Blender configuration for all future documents, or alternatively tick the Add-On in each document you use for QCT drawing.

The non-permanent option is to store the script in a text block within your Blender document. 
This has to be added to each document you make so is less desirable unless you intend to make changes to the script, as it allows for quick editing and reloading of the program.
To do this, bring up a Text Editor in a convenient window and click the 'New' button in the window header.
Paste the script into the resulting Editor.
Press Alt+P to execute the script. 
After you make changes to the script, pressing Alt+P again will re-execute the script and apply your changes. 
The location of any Python error messages is OS and execution-environment dependent.
Check documentation if you cannot find them.

Irrespective of the method, the script will add an operator named 'Import Topology' to the built-in list that can be accessed by pressing the spacebar with the 3D view active.
Additionally, the operator is added as a menu item under File -> Import -> Quantum Chemical Topology (.top).
No keyboard shortcuts are defined.

\section{Quick Start}

We recommend reading the remainder of this document before starting to use QCT4B, but realise that people do 
not like manuals.
Therefore, this section explains how to get straight into using QCT4B to generate a standard-appearance rendered 
image from a .top file.
For help with common rendering desires, see the Section 'Manipulating the Appearance'.

The Add-On will handle the import and materials (which define color and appearance) for the whole scene.
It then remains to place appropriate lights and position the camera.
The minimal demand on the user is typically to move the camera to get the desired part of the system in the final 
render.
QCT4B positions the camera such that the camera is outside the system and points at the origin.

There are 2 important 3D viewports for the quickstart user. The program will show the 3D view window once the 
system is read in.
The purpose of this view is to allow the manipulation of objects and materials, and provide a pre-rendered image 
of the scene.
The second viewport is the Camera View. The camera view shows you which objects will be rendered to the final image 
and the orientation they will have.
Thus you should check that your system appears correctly drawn in the 3D view first, and then enter the camera 
view mode to determine the viewpoint of your final 3D render.

To move the camera, it is recommended that you enter the camera view mode (keypad 0), and then use the fly mode 
(Shift-F) to position the camera using your mouse.
The enter key freezes the camera when you find the viewpoint that you want.
For larger systems, the z-clipping (which hides objects from the view deemed too far from the camera) will 
eliminate parts of your system.
If this happens, select the camera, and then its object Data panel.
Increase the value of 'End' in the 'Clipping' section until the part of your scene you want returns to the camera view.
Pressing the F12 key will invoke the Blender Render engine and produce a rendered image of your scene from the 
chosen viewpoint.
The Esc key leaves the render mode if you want to make further changes.

The camera can be moved in other ways once in camera view mode. Please see link for more details.

%http://wiki.blender.org/index.php/Doc:2.4/Manual/3D_interaction/Navigating

\chapter{Quantum Chemical Topology}

A detailed introduction to the theory of QCT (an umbrella term encompassing all methods involving topological 
analysis of scalar functions in chemistry) is outside the scope of this document.
However, a description of the relevant concepts is warranted, being a prerequisite for understanding the .top 
filetype.

\section{Components of a Topology}

A topology consists of various objects, each with different 3D representation. 
Critical points are points in space described by a position vector $r_{cp}$ and a ran and signature ($\omega$,$s$) 
which depend on the behaviour of the function around that point).
Atomic Interaction Lines (AIL) are paths through the scalar field with particular properties.
Interatomic Surfaces (IAS) are boundaries between basins.

\chapter{Describing Topology: the .top File}

\section{Introduction}

Given the variety of programs available for topological analysis of scalar functions computed from chemical 
wavefunctions, it seems apt to provide a generic file definition into which the output files of each program 
can be converted.
This filetype can then be read by QCT4B and no dependence on the underlying analysis programs exists in the code, 
meaning quirks of the topological analysis algorithms are not dealt with in QCT4B.
A further benefit is to avoid tying a user faced with importing a foreign filetype to a single technology.
That is, any language can be used to write a converter to the .top format, not just python.
The extension '.top' will be used for these files, and they are based on the xml filetype.

\section{Representing Components}

\subsection{Critical Points}
Critical points are typically represented with a sphere centered on their coordinates.
The color and radius of these spheres can be determined by their rank and signature.
In particular it is usual to set the non-nuclear CPs to have a small radius, and to use the 
van der Waals radii to set the relative sizes of nuclear attractor CPs.
The set of van der Waals radii used in the Add-On can be found in the appendix.
These are defined in a file and manipulation of defaults can be achieved by editing directly.
For CPs corresponding to nuclei, it is typical to color them by element.
Non-nuclear CPs are instead coloured by rank and signature.
Due to this mismatch between a pair of integers and an element name, a single text label is used in the .top file.
Thus a label must be defined for each CP type, and they are listed in the following table.

\begin{tabular}{ l c || r }
$\omega$ & $s$ & Label \\
\hline
0 & 0 & bcp \\
0 & 0 & rcp \\
0 & 0 & ccp \\
\end{tabular}

The complete set of element and CP colors is given in the appendix of this document. 
These are also defined in an external file which can be edited.

Blender allows spheres to be created directly.

\subsection{Atomic Interaction Lines}

Atomic Interaction Lines are rendered as curves.
At the lowest level, an AIL can be rendered as a set of disconnected points.
This can be sufficient for analysis, but is not particularly attractive.
Beyond this, the point can be connected by straight lines, or a smooth curve can be interpolated between them.
As the latter is prettiest, whis is the route taken by QCT4B.
Blender offers the ability to create an interpolated line from a set of points.

\begin{equation}
V_{m} = (1 - \lambda_{m}) V_{1} + \lambda_{m} V_{2}
\end{equation}

\chapter{The .top File}

In abstract terms, a critical point is an object with a position, rank and signature.
To represent a critical point then requires a 3-vector of floating point numbers and two signed integers.
In order to allow storage of associated CPs with other topological objects, a labelling system is also needed.
To achieve this, it is necessary to provide a mapping between the rank and signature of a CP and a String variable.
Functions for conversion in both directions then need to be defined.

A gradient vector is a set of 3-vectors of floating point numbers, each of which gives the position of a point on its line.
Special classes of gradient vector, such as AILs or those which are members of an IAS, are distinguished by their start and end points.
All gradient vectors originate at either infinity, or a critical point, and all terminate at a critical point.
In an object-oriented world, the start and end points of a given GP can be saved in a GP object as references.
When storing on disk, it is necessary to use a reliable labelling system.

An IAS is rigorously a set of gradient paths originating at a given BCP and extending to infinity.
However, when drawing an IAS without gaps, it is necessary to triangulate the surface resulting in a set of points and their connections, i.e. a graph.

\chapter{Manipulating the Appearance}

Whilst the default appearance is fine for rendering images (the MORPHY GUI has been used to render images for 
a large number of publications), the main point of writing this program is to allow you to go further.
Thus, some of the more common appearance changes are described here. 
The user is urged to think creatively and come up with things not described in this document.
A friendly user will let us know what they come up with (and how) so that others can build upon their ideas.
A perfect user would write a full description of how they did it for direct inclusion below.

\chapter{Program Notes}

The QCT4B Add-On can be summarised in the following scheme

\begin{enumerate}

  \item Read the .top file and convert into python objects.
  \item Create the Blender materials required to render the topology.
  \item Create the Blender representations (using the materials) of each topological object.
  \item Setup the Blender world such that the renderer produces the desired default result.

\end{enumerate}

The first step requires python only. A class is defined for each type of topological object.
Due to the use of XML in the .top file, the python XML library can be used to majorly simplify reading.
An object (i.e. an instantiation of one of the defined QCT classes) is created for each located topological element.
The readTopology function has the required behaviour. It takes a single argument which is the full path to the 
.top file.
An element tree is created directly from the .top file. The root of this tree is the <topology> tag, and the 
root is scanned branch-by-branch for topological objects.


The second step determines how the rendered scene will look.
The default materials are intended to replicate the GUI of the program MORPHY and use the standard render engine.
In order to maintain simplicity, a single material is created for each element rather than each atom.
This allows the user to change the appearance of all atoms of a particular element at once.
Where particular control over a single atom is needed (e.g. for emphasis), the user can create 
(via Blender's interface) a unique material for that atom.
Surfaces are dealt with in the same way, although a separate material for surfaces and nuclei of a given 
element is defined.
Similarly, all AILs share a single material with a default black colour.

Colours for the other materials are discussed above. The default material uses the Lambert diffuse shader 
(intensity 1), the Cook-Torrance specular shader (color 1,1,1 and intensity 0.5) and has alpha and ambient set to 1.
Changing these defaults currently has to be done in code, although they can be edited easily inside Blender.

Creating the blender representations (step 3) simply involves iterating over the QCT objects and calling the 
appropriate Blender functions.

Finally setting up the world really only requires addition of a light source and camera.
It is assumed the user will want to reposition this camera, so its position is essentially irrelevant.

\section{Blender Add-On Code}

Certain code is required by Blender to define an Add-On. This section discusses this code in QCT4B.
First the program has to import bpy, the blender python API.
The Add-On itself is defined as a class that takes an Operator argument.
The operator has to be given an ID 
%(qct.import_topology)%
 and a label (Import Topology).
The operator class requires definition of the classes 'execute' (called when the user runs the script)
and 'invoke'.
Invoke opens a file select window with the filter set to only include files with the .top extension.
Execute carries out the four steps discussed above.
It is also necessary for the Add-On to define register and unregister functions which are used to include the Add-On 
in Blender itself.
As suggested, these classes just register and deregister the operator. The register function is called when the 
script is added.
This is achieved by the only line of executable code in the main program.
Finally Blender required the definition of a dictionary. %bl_info.
This contains basic information about the Add-On for display inside Blender, including the author, version number etc.

\end{document}
